
<!DOCTYPE html>
<html>
<head>
<title>webQA</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
<script src="https://cdn.jsdelivr.net/sockjs/0.3.4/sockjs.min.js"></script>
<script src="/js/jquery-2.1.4.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script type="text/javascript">
	var ws = null;
	var his_log="";

	function connect() {
		ws = new SockJS("/my");
		ws.onopen = function() {
			var username = $("#username").val();
			var jsonMsg = {};
			jsonMsg.type="join";
			jsonMsg.username=username;
			jsonString = JSON.stringify(jsonMsg);
			ws.send(jsonString);
			$("#join").attr("disabled",true);
		};
		ws.onmessage = function(event) {
			var data = JSON.parse(event.data);
			switch(data.type){
			case "select":
				log(data.result);
				break;
			case "join":
				log("用户:"+data.userName+"加入了！");
				break;
			case "userlist":
				loguser(data.users);
				break;
			case "leave":
				log("用户:"+data.userName+"离开了！");
				break;
			case "chat":
				log(data.content);
				break;
			}
			$("#content").scrollTop(999999);
		};
		ws.onclose = function() {
			
		};
	}

	function disconnect() {
		if (ws != null) {
			ws.close();
			ws = null;
		}
	}

	function select() {
		if (ws != null) {
			var word = $("#chenyu").val().trim();
			var jsonMsg = {};
			var arr = word.split(" ");
			if(arr[0]=="@zy"){
				jsonMsg.type="select";
				jsonMsg.word=word.substring(word.indexOf(" ")+1);
				
			}else if(arr[0].indexOf("@") != -1){
				jsonMsg.type = "chatToOne";
				jsonMsg.target = arr[0].substring(1);
				if(word.indexOf(" ")!=-1){
					jsonMsg.word=word.substring(word.indexOf(" "));
				}else
					jsonMsg.word=" ";
			}else{
				jsonMsg.type = "chatToAll";
				jsonMsg.word = word;
			}
			jsonString = JSON.stringify(jsonMsg);
			ws.send(jsonString);
		} else {
			alert('请先加入');
		}
	}

	function log(message) {
		if(his_log != ""){
			his_log+="\r\n";
		}
		his_log+=message;
		$("#content").val(his_log);
	}
	
	function loguser(message) {
		var loguser="";
		for(i=0;i<message.length;i++){
			loguser+=message[i];
			loguser+="\r\n";
			$("#userlist").val(loguser);
		}
	}

</script>
</head>
<body>
	<noscript>
		<h2>Seems your browser doesn't support Javascript! Websockets
			rely on Javascript being enabled. Please enable Javascript and reload
			this page!</h2>
	</noscript>
	<div class="container-fluid">
		<div class="row">
			<div class="page-header">
				<h1 style="text-align: center;">
					Websocket<small>&nbsp;sample</small>
				</h1>
			</div>
		</div>
		<br>
		<div class="col-md-offset-2 col-md-5">
			<div class="row">
				<div class="col-md-6">
					<input id="username" type="text" class="form-control"
						placeholder="请输入用户名">
				</div>
				<div class="col-md-1">
					<button id="join" class="btn btn-info" onclick="connect()">加入</button>
				</div>
			</div>
			<br>
			<div class="row">
				<div class="col-md-6">
					<input id="chenyu" type="text" class="form-control"
						placeholder="请输入成语">
				</div>
				<div class="col-md-1">
					<button id="select" class="btn btn-primary" onclick="select()">发送</button>
				</div>
			</div>
			<br>
			<div class="row">
				<textarea rows="15" cols="60" id="content"></textarea>
			</div>
		</div>
		<div class="col-md-2">
			<label>在线用户列表：</label>
			<textarea id="userlist" rows="19" cols="20"></textarea>
		</div>
	</div>
</body>
</html>
